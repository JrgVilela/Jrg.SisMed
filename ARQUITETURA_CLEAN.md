# ??? Arquitetura Clean - Jrg.SisMed

## ?? Diagrama de Camadas (Clean Architecture)

```
??????????????????????????????????????????????????????????????????????
?                         PRESENTATION LAYER                         ?
?                         (Jrg.SisMed.Api)                          ?
?                                                                    ?
?  ????????????????     ????????????????     ????????????????     ?
?  ? Controllers  ?     ?   Requests   ?     ?  Responses   ?     ?
?  ?              ???????    (DTOs)    ???????   (ViewModels)?     ?
?  ????????????????     ????????????????     ????????????????     ?
?         ?                                                          ?
?         ? Depende de Application                                  ?
??????????????????????????????????????????????????????????????????????
          ?
          ?
??????????????????????????????????????????????????????????????????????
?                       APPLICATION LAYER                            ?
?                   (Jrg.SisMed.Application)                        ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                     DTOs (Contratos)                      ?    ?
?  ?  • CreateProfessionalDto (abstract)                      ?    ?
?  ?  • CreatePsychologistDto                                 ?    ?
?  ?  • CreateNutritionistDto                                 ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ???????????????????????      ???????????????????????           ?
?  ?   Factories         ?      ?    Providers        ?           ?
?  ?  (Implementam       ????????  (Resolvem          ?           ?
?  ?   interfaces do     ?      ?   factories via DI) ?           ?
?  ?   Domain)           ?      ?                     ?           ?
?  ?                     ?      ?                     ?           ?
?  ? • Psychology        ?      ? • Professional      ?           ?
?  ?   ModuleFactory     ?      ?   ModuleFactory     ?           ?
?  ? • Nutrition         ?      ?   Provider          ?           ?
?  ?   ModuleFactory     ?      ?                     ?           ?
?  ???????????????????????      ???????????????????????           ?
?         ?                                                          ?
?         ? Usa DTOs e implementa interfaces                        ?
?         ? Depende de Domain                                       ?
??????????????????????????????????????????????????????????????????????
          ?
          ?
??????????????????????????????????????????????????????????????????????
?                         DOMAIN LAYER                               ?
?                      (Jrg.SisMed.Domain)                          ?
?                    ?? CAMADA MAIS INTERNA ??                      ?
?                      SEM DEPENDÊNCIAS!                             ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                        Entities                           ?    ?
?  ?  • Person (abstract)                                      ?    ?
?  ?  • Psychologist : Person                                  ?    ?
?  ?  • Nutritionist : Person                                  ?    ?
?  ?  • Organization                                           ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                      Interfaces                           ?    ?
?  ?  • IProfessionalModuleFactory                            ?    ?
?  ?    (usa apenas tipos primitivos)                          ?    ?
?  ?  • IRepository<T>                                         ?    ?
?  ?  • IUnitOfWork                                           ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                      Enumerators                          ?    ?
?  ?  • ProfessionalType                                       ?    ?
?  ?  • PersonEnum.Gender                                      ?    ?
?  ?  • PersonEnum.State                                       ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                      Attributes                           ?    ?
?  ?  • ProfessionalTypeAttribute                             ?    ?
?  ????????????????????????????????????????????????????????????    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?                    Domain Logic                           ?    ?
?  ?  • Validations                                            ?    ?
?  ?  • Business Rules                                         ?    ?
?  ?  • Domain Exceptions                                      ?    ?
?  ????????????????????????????????????????????????????????????    ?
??????????????????????????????????????????????????????????????????????
          ?
          ?
??????????????????????????????????????????????????????????????????????
?                      INFRASTRUCTURE LAYER                          ?
?                   (Jrg.SisMed.Infra.Data)                         ?
?                                                                    ?
?  ????????????????????    ????????????????????                    ?
?  ?  Repositories    ?    ?  DbContext       ?                    ?
?  ?  (Implementam    ??????  (EF Core)       ?                    ?
?  ?   interfaces do  ?    ?                  ?                    ?
?  ?   Domain)        ?    ?                  ?                    ?
?  ????????????????????    ????????????????????                    ?
?                                                                    ?
?  ????????????????????????????????????????????????????????????    ?
?  ?            Entity Configurations                          ?    ?
?  ?  • PersonConfiguration                                    ?    ?
?  ?  • PsychologistConfiguration                             ?    ?
?  ?  • NutritionistConfiguration                             ?    ?
?  ????????????????????????????????????????????????????????????    ?
??????????????????????????????????????????????????????????????????????
          ?
          ?
??????????????????????????????????????????????????????????????????????
?                     DEPENDENCY INJECTION                           ?
?                     (Jrg.SisMed.Infra.IoC)                        ?
?                                                                    ?
?  • Registra factories                                             ?
?  • Registra providers                                             ?
?  • Configura DI Container                                         ?
??????????????????????????????????????????????????????????????????????
```

---

## ?? Fluxo de Dependências

```
Api ??????? Application ??????? Domain
                ?                   ?
                ?                   ?
                ?                   ?
         Infra.Data ?????????????????
                ?
                ?
           Infra.IoC
```

**Regra de Ouro:** Dependências sempre apontam para **DENTRO** (para o Domain)

---

## ?? Responsabilidades de Cada Camada

### ?? API Layer (Presentation)
**Responsabilidades:**
- Receber requisições HTTP
- Validar dados de entrada
- Converter Requests para DTOs da Application
- Chamar Services/Factories da Application
- Retornar Responses

**Pode Depender De:**
- Application ?

**NÃO Pode Depender De:**
- Infrastructure ? (exceto via IoC)

---

### ?? Application Layer
**Responsabilidades:**
- Definir casos de uso (Use Cases)
- Orquestrar Domain (chamar entidades e serviços)
- Definir DTOs (contratos de entrada/saída)
- Implementar Factories que usam DTOs
- Implementar Services de aplicação

**Pode Depender De:**
- Domain ?

**NÃO Pode Depender De:**
- API ?
- Infrastructure ?

**Contém:**
```
Application/
  ??? DTOs/                    ? Contratos de entrada/saída
  ??? Factories/               ? Implementam interfaces do Domain
  ??? Services/                ? Casos de uso
  ??? Providers/               ? Resolvedores
```

---

### ?? Domain Layer (Core)
**Responsabilidades:**
- Definir entidades e agregados
- Implementar regras de negócio
- Definir interfaces (ports)
- Definir value objects
- Validações de domínio
- **NENHUMA DEPENDÊNCIA EXTERNA!**

**NÃO Pode Depender De:**
- API ?
- Application ?
- Infrastructure ?
- **Nenhuma biblioteca externa exceto as essenciais** ?

**Contém:**
```
Domain/
  ??? Entities/                ? Lógica de negócio
  ??? Interfaces/              ? Contratos (só tipos primitivos!)
  ??? Enumerators/             ? Enums do domínio
  ??? Attributes/              ? Metadados
  ??? Exceptions/              ? Exceções do domínio
  ??? Helpers/                 ? Auxiliares puros
```

---

### ??? Infrastructure Layer
**Responsabilidades:**
- Implementar interfaces do Domain (Repositories)
- Acesso a banco de dados (EF Core)
- Configurações de persistência
- Integrações externas

**Pode Depender De:**
- Domain ?

**Implementa:**
```
Infrastructure/
  ??? Data/
  ?   ??? Context/             ? DbContext
  ?   ??? Repositories/        ? Implementa IRepository do Domain
  ?   ??? EntityConfiguration/ ? Mapeamento EF Core
  ??? IoC/
      ??? DependencyInjection/ ? Configuração do DI
```

---

## ?? Porque DTOs Estão na Application?

### ? Se estivessem no Domain:
```csharp
// Domain/DTOs/CreatePsychologistDto.cs  ? ERRADO
public record CreatePsychologistDto(...);

// Domain/Interfaces/IProfessionalModuleFactory.cs
public interface IProfessionalModuleFactory
{
    Person CreateProfessional(CreatePsychologistDto dto);  
    // ? Domain conhecendo DTO = violação arquitetural
}
```

**Problemas:**
1. Domain fica acoplado a estrutura de transferência de dados
2. Mudanças na API afetariam o Domain
3. Domain perde reusabilidade
4. Viola princípio de dependência

### ? Na Application (correto):
```csharp
// Domain/Interfaces/IProfessionalModuleFactory.cs  ? CORRETO
public interface IProfessionalModuleFactory
{
    Person CreateProfessional(string name, string cpf, ...);
    // ? Domain usa apenas tipos primitivos
}

// Application/DTOs/CreatePsychologistDto.cs  ? CORRETO
public record CreatePsychologistDto(...);

// Application/Factories/PsychologyModuleFactory.cs
public class PsychologyModuleFactory : IProfessionalModuleFactory
{
    // ? Método adicional que usa DTO (Application)
    public Person CreateProfessionalFromDto(CreatePsychologistDto dto)
    {
        return CreateProfessional(dto.Name, dto.Cpf, ...);
    }
    
    // ? Implementação da interface Domain (primitivos)
    public Person CreateProfessional(string name, string cpf, ...)
    {
        return new Psychologist(name, cpf, ...);
    }
}
```

**Vantagens:**
1. ? Domain permanece puro
2. ? Application orquestra usando DTOs
3. ? Mudanças na API não afetam Domain
4. ? Domain é reutilizável
5. ? Respeita Clean Architecture

---

## ?? Referências

- **Clean Architecture** - Robert C. Martin
- **Domain-Driven Design** - Eric Evans
- **Onion Architecture** - Jeffrey Palermo
- **Hexagonal Architecture** - Alistair Cockburn

---

**Data:** ${new Date().toLocaleDateString('pt-BR')}
**Arquitetura:** Clean Architecture ?
**Status:** Validado e Implementado Corretamente
